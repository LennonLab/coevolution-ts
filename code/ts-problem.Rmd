---
title: "Time series analysis"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
```{r setup, include=FALSE}
library(renv)
# install to projectlibray the resuired packages
renv::restore()
# # Initialize lock file when first setting repo
# renv::init()

library(here)
# # set root at project file ("coevolution-ts"). 
# # Done once at initial setup.
# here::set_here()

library(tidyverse)
library(cowplot)


library(nlme)
library(car)

```

I have a dataset of bacteria and phage populations collected over the course of 28 days of an experimental co-evolution trial. In the example here we wil focus on the total bacterial cell density. 

**Experimental design**  
The experiment was setup to test the influence of host seed banks of coevolution with phage. The experiment included 2 treatments:  
 **phage** (2 levels):  
-- phage SPO1 added to cultures at time 0  
-- no phage added.   
 **seed bank** (3 levels):  
-- no seed bank - genetic mutant that cannot sporulate  
-- short residence-time seed bank - most spores germinate upon   transfer  
-- long residence-time seed bank - Spores at each transfer are mixed with older spores that are maintained in fridge.  

Three replicated lines of each treatment were maintained independently.

**Transfer regime**: cultures were grown in rich sporulation media, that is media containing ample resources to enable the population to reach high densities. However upon resource depletion many of the cells will sporulate and become dormant. To allow time for sporulation to reach completion, even when resource depletion was delayed by phage lysis, transfers were done every other day. Transfer were done by sampling 1% of the population, then used to inoculate fresh media. 
Sampling: population samples were taken daily and analyzed by flow cytometry. Counts include both spores and vegatative cells. Note that **the frequency of sampling is double that of transfer**. this generates a *seasonal-like* trend in the data.

```
Flow-cytometry detection limit

The flow cytometer stop conditions were either 50uL or 50,000 events, whatever came first.  
In addition, to account for false asignments by noise I required that a gated population have at least 100 events to be taken into account. So the minimal detected population would have 100 cells in 50uL of analyzed liquid. At this point of the experiment we were analyzing x100 diluted samples.
```

```{r}
detection.limit <- 100 * (1000/50) * 100
```



**The data**  


```{r load data, echo=FALSE, message=FALSE}
d <- read_csv(here("data","coevolution_pop_density.csv"), )

#add columns on host strain and phage treatment  as encoded in culture name
d <- 
  d%>%
  mutate(host=case_when(grepl("W", culture) ~ "WT",
                         grepl("SN", culture) ~ "dSpoIIE",
                         grepl("dS", culture) ~ "dSpoIIE"))%>%
  
  mutate(phage=case_when(grepl("O", culture) ~ "SPO1",
                         grepl("Ct", culture) ~ "no_Phage",
                         grepl("ANC", line) ~ "no_Phage"))%>%

   mutate(seed.bank = fct_relevel(seed.bank, "long","short","none"))%>%
  #add flask to be used as grouping variable
  mutate(flask=paste(culture,line, sep = "-"))%>%
  #remove setup data
  filter(Time>=0)

# plot raw data
d%>%
    ggplot(aes(x=Time, y=cell.ml))+
      geom_hline(yintercept = detection.limit, color="red")+
  geom_label(label="detection limit", x=10, y=log10(detection.limit), color="red")+
      geom_line(aes(group=flask,color=seed.bank), size=1, alpha=0.7)+
      facet_grid(.~phage)+
      theme_bw()+
      panel_border()+
      scale_y_log10()+
      theme(legend.position = "bottom",
            text=element_text(size=14))+
      ylab("cell/ml (log)")+
      coord_cartesian(ylim = c(1e5, 1e10))
```

Three points across 2 cultres, were below the detection limit. However since there was regrowth we know the cells remained above 0. We will asign these points a value that is 50% of the detection limit ($10^5$ cells/ml). We can now also summarize the data.  

```{r}
d <- d%>%
  mutate(cell.ml=if_else(cell.ml>10, cell.ml,detection.limit/2))

# plot total cells of raw data
d%>%
  group_by(phage,seed.bank,Time)%>%
  summarise(n=n(),sd=sd(cell.ml), cell.ml=mean(cell.ml), sem=sd/sqrt(n))%>%
    ggplot(aes(x=Time, y=cell.ml))+
  geom_errorbar(aes(ymin=cell.ml-sem,ymax=cell.ml+sem,color=seed.bank), alpha=0.7)+
      geom_line(aes(color=seed.bank), size=1, alpha=0.7)+
      facet_wrap(~phage)+
      theme_bw()+
      panel_border()+
      scale_y_log10()+
      theme(legend.position = "bottom",
            text=element_text(size=14))+
      ylab("cell/ml (log)")+
      coord_cartesian(ylim = c(1e5, 2e9))+
  labs(caption  = "mean +/- SEM")
```


We now want to evaluate the effect of the treatments (phage, seed bank) on the resppnse (cell/ml). In our analysis we wish to account for temporal autocorelation within the samples of each culture (labeled below as flask). In addition we eant to account for the seasonal variation caused by transfering every other day.

The aproach is to conduct an RM-ANOVA, similar to anlaysis done by Laren and Lennon. Here is one such model:

```{r, evaluate=FALSE}
# this is a mixed equation model where day and treatment are fixed factors, while cID is a random factor  
model.ar <- lme(log.abd ~ lim * day.fac,
                random = ~ 1 | cID, 
                correlation=corAR1(form = ~ 1 | cID),
                data = phage)
```  

In my understanding this model tests the response `log.abd` (abundance data) to 2 fixed effects:`lim` treatment (limiting nutrient) and `day.fac` (Time as a factor). In addition each of the chemostats (`cID`) is specified as a random effect. The auto-correlation is apecified by an `corAR1` being "*an autocorrelation structure of order 1*".

In the coevolution data we want to ask if the treatments of phage and seed bank had an effect on the host population density. Specifically we hypothesize that in the presence of phages seed-banks will have a greater effect on host population size, as dormancy serves as a refuge from phage infection. This would manifest as an interaction of the phage and seed banks treatment.

**Adjusting the model**  
The model for our data 2 fixed effects, pahge and seed bank, in addtion to time. We also have a random groupng factor specifying the 18 different indivduals flasks. Since we are intrested in the main effects as well as the interactions (2-way and 3-way) we can specify the following formula for a model:  

```{r, eval=FALSE}
cell.ml ~ phage * seed.bank * Time, random = ~1|flask

```
(according to https://rcompanion.org/handbook/G_03.html: "*1 indicates that an intercept is to be fitted for each level of the random variable*".

Lets run this simple model:  
```{r}
m <- d%>%
  mutate(phage=as.factor(phage))%>%
  mutate(seed.bank=as.factor(seed.bank))%>%
  mutate(Time=as.factor(Time))%>%
  mutate(flask=as.factor(flask))%>%
  lme(cell.ml ~ phage * seed.bank * Time ,
        random = ~1|flask,
      correlation = corARMA(form = ~1|flask,p=2),
      data=.)

Anova(m)
ACF(m)%>%plot(alpha=0.01)
```

Let's not interpret these results yet beacuse we have not accounted for temporal auto-correlation yet. Lets look at the auto-correlation of the model residulas:

```{r}
ACF(m)%>%plot(alpha=0.01)
ACF(m)%>%ar(aic = T)
```

It can be seen that significant autocroeelation exists which id positive for even ags and negative (anti-correlation) for odd lags (except for lag=1). This is to be expected given the transfer regime: even lags match samples from the same transfer phase and oss ones are out of phase. To address this we specify an autoregressive model with an order of 2.

```{r}
m <- d%>%
  mutate(Time=as.factor(Time))%>%
  lme(cell.ml ~ phage * seed.bank * Time ,
        random = ~1|flask,
      correlation = corARMA(form = ~Time|flask, p=2,q=1),
      data=.)

ACF(m)%>%plot(alpha=0.01)

```

This got rid of the odd lag anticorrelation but not of the even lag correlation.

Before we move I would like to address the formula passed to the correlation function.  according to the help page for corARMA:  

> **form**: a one sided formula of the form ~ t, or ~ t | g, specifying a time covariate t and, optionally, a grouping factor g. A covariate for this correlation structure must be integer valued. When a grouping factor is present in form, the correlation structure is assumed to apply only to observations within the same grouping level; observations with different grouping levels are assumed to be uncorrelated. Defaults to ~ 1, which corresponds to using the order of the observations in the data as a covariate, and no groups.

In my indersatnsing from variuos examples (e.g.)


```{r}
n=10
pvals <- rep(NA,n)

for (i in 1:n)
{
  p <- 
d%>%
  mutate(Time=i*Time)%>%
    mutate(Time=as.factor(Time))%>%
    lme(cell.ml ~ phage * seed.bank * Time ,
        random = ~1|flask, 
        correlation = corARMA(form = ~ 1 | flask, p=2),
        data = .)%>%
  anova.lme()

# extract main effect of seed bank p value
pvals[i] <- p$`p-value`[3]
}


qplot(1:n, pvals)+
  geom_line()+
  geom_hline(yintercept = 0.05, color="red")+
  ylab("p-value for seed-bank main effect")+
  xlab("Time mutliplication coefficient")

```


